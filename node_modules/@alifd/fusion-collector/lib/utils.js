'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.getGitConfig = getGitConfig;

var _debug = require('debug');

var _debug2 = _interopRequireDefault(_debug);

var _gracefulFs = require('graceful-fs');

var _gracefulFs2 = _interopRequireDefault(_gracefulFs);

var _os = require('os');

var _os2 = _interopRequireDefault(_os);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _ini = require('ini');

var _ini2 = _interopRequireDefault(_ini);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var debug = (0, _debug2.default)('next:collect');

/**
 * 获取 git 信息：包括本次提交者花名，仓库地址等
 */
/**
 * Created at 16/7/11.
 * @Author Ling.
 * @Email i@zeroling.com
 */
function getGitConfig(dir) {
    var homedir = _os2.default.homedir();
    var gitGlobalPath = _path2.default.join(homedir, '.gitconfig');
    var gitGlobalConfig = {};
    var gitLocalConfig = {};

    if (_gracefulFs2.default.existsSync(gitGlobalPath)) {
        try {
            gitGlobalConfig = _ini2.default.parse(_gracefulFs2.default.readFileSync(gitGlobalPath, 'utf-8'));
        } catch (err) {
            debug('git config 错误：', err.message);
            gitGlobalConfig = {};
        }
    }

    var gitLocalPath = _path2.default.join(dir, '.git/config');
    if (_gracefulFs2.default.existsSync(gitLocalPath)) {
        try {
            gitLocalConfig = _ini2.default.parse(_gracefulFs2.default.readFileSync(gitLocalPath, 'utf-8'));
        } catch (err) {
            debug('git config 错误：', err.message);
            gitLocalConfig = {};
        }
    }

    var url = (gitLocalConfig['remote "origin"'] || {})['url'] || '';
    var repoName = '';
    if (url) {
        repoName = (url.match(/.*\.com[:\/](.*\/.*)\.git/) || [,])[1];
    }

    var userName = (gitLocalConfig.user || gitGlobalConfig.user || {})['name'];
    return {
        url: url,
        repoName: repoName,
        userName: userName
    };
}